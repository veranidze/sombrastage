<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BandFlow Supabase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Supabase
        const SUPABASE_URL = 'https://llzpyhmhdbckkiovjiig.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsenB5aG1oZGJja2tpb3ZqaWlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4Mjc0ODgsImV4cCI6MjA4NjQwMzQ4OH0.NoXKtNS3QtFyv-JLF_bRx_xusBRGWX_EukBgT3Cz4To';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Telegram
        const TG_BOT_TOKEN = "8589462243:AAFKM4TYkNQzGddVbdE7esNUkvwWfsO-SGQ";
        const TG_CHAT_ID = "-5261222041";

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let songs = [];
        let activeSongId = null;
        let isSending = false;

        // –≠–ª–µ–º–µ–Ω—Ç—ã UI
        const songListContainer = document.getElementById('song-list');
        const statusToast = document.getElementById('status-toast');
        const toastText = document.getElementById('toast-text');
        const songModal = document.getElementById('song-modal');
        const songForm = document.getElementById('song-form');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            await fetchSongs();
            await fetchStatus();
            setupRealtime();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Å–µ–Ω
        async function fetchSongs() {
            const { data, error } = await supabaseClient
                .from('songs')
                .select('*')
                .order('order', { ascending: true });
            
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Å–µ–Ω:', error);
            } else {
                songs = data || [];
                renderSongs();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
        async function fetchStatus() {
            const { data, error } = await supabaseClient
                .from('status')
                .select('active_song_id')
                .eq('id', 1)
                .single();
            
            if (!error && data) {
                activeSongId = data.active_song_id;
                renderSongs();
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        function setupRealtime() {
            // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π
            supabaseClient.removeAllChannels();

            // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –í–°–ï –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ –ø–µ—Å–µ–Ω (INSERT, UPDATE, DELETE)
            supabaseClient
                .channel('schema-db-changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'songs' 
                    }, 
                    (payload) => {
                        console.log('–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –ø–µ—Å–Ω—è—Ö:', payload);
                        fetchSongs(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –ª—é–±–æ–º —Å–æ–±—ã—Ç–∏–∏
                    }
                )
                .on('postgres_changes', 
                    { 
                        event: 'UPDATE', 
                        schema: 'public', 
                        table: 'status', 
                        filter: 'id=eq.1' 
                    }, 
                    payload => {
                        console.log('–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞:', payload);
                        activeSongId = payload.new.active_song_id;
                        renderSongs();
                    }
                )
                .subscribe((status) => {
                    console.log('–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ Supabase:', status);
                });
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π
        window.announceSong = async (id) => {
            if (isSending) return;
            const song = songs.find(s => s.id === id);
            if (!song) return;

            isSending = true;
            
            try {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ Supabase
                await supabaseClient
                    .from('status')
                    .upsert({ id: 1, active_song_id: id, updated_at: new Date() });

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
                const message = `<b>–°–õ–ï–î–£–Æ–©–ê–Ø –ü–ï–°–ù–Ø:</b>\nüéµ <b>${song.title.toUpperCase()}</b>`;
                await fetch(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: TG_CHAT_ID, text: message, parse_mode: 'HTML' })
                });

                showToast(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${song.title}`);
            } catch (err) {
                console.error(err);
                showToast("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
            } finally {
                isSending = false;
            }
        };

        window.toggleExpand = (id) => {
            const el = document.getElementById(`lyrics-${id}`);
            if (el) el.classList.toggle('hidden');
        };

        window.openEditModal = (id = null) => {
            const song = id ? songs.find(s => s.id === id) : { title: '', lyrics: '', order: (songs.length > 0 ? Math.max(...songs.map(s => s.order)) + 1 : 1) };
            document.getElementById('modal-title').innerText = id ? '–ü—Ä–∞–≤–∫–∞ –ø–µ—Å–Ω–∏' : '–ù–æ–≤–∞—è –ø–µ—Å–Ω—è';
            document.getElementById('song-id').value = id || '';
            document.getElementById('input-title').value = song.title;
            document.getElementById('input-lyrics').value = song.lyrics || '';
            document.getElementById('input-order').value = song.order;
            document.getElementById('delete-btn').classList.toggle('hidden', !id);
            songModal.classList.remove('hidden');
            songModal.classList.add('flex');
        };

        window.closeModal = () => {
            songModal.classList.add('hidden');
            songModal.classList.remove('flex');
        };

        window.deleteCurrentSong = async () => {
            const id = document.getElementById('song-id').value;
            if (id && confirm('–£–¥–∞–ª–∏—Ç—å –ø–µ—Å–Ω—é –Ω–∞–≤—Å–µ–≥–¥–∞?')) {
                const { error } = await supabaseClient.from('songs').delete().eq('id', id);
                if (error) {
                    console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", error);
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏.");
                } else {
                    closeModal();
                }
            }
        };

        songForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('song-id').value;
            const songData = {
                title: document.getElementById('input-title').value,
                lyrics: document.getElementById('input-lyrics').value,
                order: Number(document.getElementById('input-order').value)
            };

            let error;
            if (id) {
                const res = await supabaseClient.from('songs').update(songData).eq('id', id);
                error = res.error;
            } else {
                const res = await supabaseClient.from('songs').insert([songData]);
                error = res.error;
            }

            if (!error) {
                closeModal();
            } else {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error);
                alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤ Supabase.");
            }
        };

        function showToast(text) {
            toastText.innerText = text;
            statusToast.classList.remove('hidden');
            setTimeout(() => statusToast.classList.add('hidden'), 3000);
        }

        function renderSongs() {
            if (songs.length === 0) {
                songListContainer.innerHTML = `
                    <div class="text-center py-12 border-2 border-dashed border-slate-200 rounded-[40px] bg-white">
                        <p class="text-slate-400 font-bold uppercase text-[10px]">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</p>
                    </div>`;
                return;
            }

            songListContainer.innerHTML = songs.map(song => `
                <div class="transition-all duration-300 rounded-3xl overflow-hidden border-2 ${activeSongId == song.id ? 'bg-white border-emerald-500 shadow-xl scale-[1.02]' : 'bg-white border-transparent shadow-sm'} mb-4">
                    <div class="p-5 flex items-center justify-between">
                        <div class="flex-1 cursor-pointer flex items-center gap-4" onclick="toggleExpand('${song.id}')">
                            <span class="text-sm font-black w-6 ${activeSongId == song.id ? 'text-emerald-600' : 'text-slate-300'}">
                                ${String(song.order || 0).padStart(2, '0')}
                            </span>
                            <h3 class="font-black text-lg tracking-tight ${activeSongId == song.id ? 'text-emerald-600' : 'text-slate-800'}">
                                ${song.title}
                            </h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="announceSong('${song.id}')" class="p-3 rounded-2xl ${activeSongId == song.id ? 'bg-emerald-600 text-white shadow-lg' : 'bg-slate-100 text-slate-400 hover:text-emerald-600'} transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            </button>
                        </div>
                    </div>
                    <div id="lyrics-${song.id}" class="hidden px-6 pb-6 border-t border-slate-50 bg-slate-50/30">
                        <div class="flex justify-between items-center py-3">
                            <span class="text-[10px] font-black uppercase text-slate-400">–¢–µ–∫—Å—Ç / –ê–∫–∫–æ—Ä–¥—ã</span>
                            <button onclick="openEditModal('${song.id}')" class="text-[10px] font-black uppercase text-emerald-600 px-2 py-1 bg-emerald-50 rounded hover:bg-emerald-100 transition-colors">–ü—Ä–∞–≤–∫–∞</button>
                        </div>
                        <pre class="whitespace-pre-wrap font-mono text-sm text-slate-700 bg-white p-4 rounded-xl border border-slate-100">${song.lyrics || '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞'}</pre>
                    </div>
                </div>
            `).join('');
        }

        window.onload = init;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-24 text-slate-900">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-20 px-4 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-emerald-600 p-2 rounded-xl shadow-lg shadow-emerald-100 text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
            </div>
            <div>
                <h1 class="font-black text-xl tracking-tight leading-none uppercase italic">BandFlow</h1>
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">Cloud Sync</span>
            </div>
        </div>
        <div class="px-3 py-1 bg-emerald-50 rounded-full border border-emerald-100 flex items-center gap-2">
            <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
            <span class="text-[10px] font-black text-emerald-600 uppercase">Live DB</span>
        </div>
    </header>

    <main class="max-w-xl mx-auto p-4">
        <div id="status-toast" class="hidden mb-6 bg-emerald-600 text-white p-5 rounded-2xl shadow-xl flex items-center justify-between">
            <div class="flex items-center gap-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                <span id="toast-text" class="font-bold text-xs uppercase"></span>
            </div>
        </div>

        <div id="song-list">
            <div class="text-center py-20">
                <p class="text-slate-400 font-bold uppercase text-[10px] animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±–ª–∞–∫–∞...</p>
            </div>
        </div>
    </main>

    <button onclick="openEditModal()" class="fixed bottom-8 right-8 bg-emerald-600 text-white w-16 h-16 rounded-3xl shadow-2xl flex items-center justify-center hover:scale-110 active:scale-95 transition-all z-30">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
    </button>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    <div id="song-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden items-end sm:items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[32px] shadow-2xl overflow-hidden p-8 animate-in">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-black tracking-tight uppercase italic text-emerald-600">–ü–µ—Å–Ω—è</h2>
                <button id="delete-btn" onclick="deleteCurrentSong()" class="p-2 text-red-500 hover:bg-red-50 rounded-xl transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"/></svg>
                </button>
            </div>
            <form id="song-form" class="space-y-4">
                <input type="hidden" id="song-id">
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-400 ml-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="input-title" required class="w-full bg-slate-50 border-2 border-transparent focus:border-emerald-500 rounded-2xl px-5 py-3 font-bold outline-none transition-all">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-400 ml-1">–¢–µ–∫—Å—Ç / –ê–∫–∫–æ—Ä–¥—ã</label>
                    <textarea id="input-lyrics" class="w-full bg-slate-50 border-2 border-transparent focus:border-emerald-500 rounded-2xl px-5 py-3 h-32 font-mono text-sm outline-none resize-none transition-all"></textarea>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-slate-400 ml-1">–ü–æ—Ä—è–¥–æ–∫</label>
                    <input type="number" id="input-order" class="w-full bg-slate-50 border-2 border-transparent focus:border-emerald-500 rounded-2xl px-5 py-3 font-bold outline-none transition-all">
                </div>
                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="closeModal()" class="flex-1 py-4 font-bold text-slate-500 hover:bg-slate-50 rounded-2xl">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="flex-[2] py-4 bg-emerald-600 text-white rounded-2xl font-black shadow-lg hover:bg-emerald-700 transition-colors">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>
